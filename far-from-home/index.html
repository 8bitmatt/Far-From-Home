<html>
<head>
<title>FAR FROM HOME</title>
<style type="text/css">
/* Sprite animations 
======================== */

@-moz-keyframes moveBg {
	0% { -moz-transform: translate(0, 0); }
	100% { -moz-transform: translate(0, 1200px); }
}
@-webkit-keyframes moveBg {
	0% { -webkit-transform: translate3d(0px, 0, 0px); }
	100% { -webkit-transform: translate3d(0px, 1200px, 0px); }
}

@-moz-keyframes spriteSpaceman {
	0%, 100% { background-position: 0 0;}
	50% { background-position: -23px 0;}
}
@-webkit-keyframes spriteSpaceman {
	0%, 100% { background-position: 0 0;}
	50% { background-position: -23px 0;}
}


@-moz-keyframes spriteMmicro {
	0%, 100% { background-position: 0 0;}
	25% { background-position: -17px 0;}
	50% { background-position: -34px 0;}
	75% { background-position: -51px 0;}
}
@-webkit-keyframes spriteMmicro {
	0%, 100% { background-position: 0 0;}
	25% { background-position: -17px 0;}
	50% { background-position: -34px 0;}
	75% { background-position: -51px 0;}
}

@-moz-keyframes spriteMnorm {
	0%, 100% { background-position: 0 0;}
	25% { background-position: -32px 0;}
	50% { background-position: -63px 0;}
	75% { background-position: -96px 0;}
}
@-webkit-keyframes spriteMnorm {
	0%, 100% { background-position: 0 0;}
	25% { background-position: -32px 0;}
	50% { background-position: -63px 0;}
	75% { background-position: -96px 0;}
}

@-moz-keyframes spriteMmega {
	0%, 100% { background-position: 0 0;}
	25% { background-position: -63px 0;}
	50% { background-position: -128px 0;}
	75% { background-position: -191px 0;}
}
@-webkit-keyframes spriteMmega {
	0%, 100% { background-position: 0 0;}
	25% { background-position: -63px 0;}
	50% { background-position: -128px 0;}
	75% { background-position: -191px 0;}
}

@-moz-keyframes spriteSolarwind {
	0%, 100% { background-position: 0 0;}
	50% { background-position: -30px 0;}
}
@-webkit-keyframes spriteSolarwind {
	0%, 100% { background-position: 0 0;}
	50% { background-position: -30px 0;}
}

@-moz-keyframes spriteO2bottle {
	0%, 100% { background-position: 0 0;}
	50% { background-position: -11px 0;}
}
@-webkit-keyframes spriteO2bottle {
	0%, 100% { background-position: 0 0;}
	50% { background-position: -11px 0;}
}

.animate {
	-webkit-backface-visibility: hidden; /* to maybe prevent flickering */
}

.pause {
	-moz-animation-play-state: paused !important;
	-webkit-animation-play-state: paused !important;
}

/* Page styles 
======================== */
html, body {
	margin: 0;
	padding: 0;
	background: #111;
	height: 100%;
	overflow: hidden;
	image-rendering: -webkit-optimize-contrast;
	image-rendering: -moz-crisp-edges;
}
#wrap { 
	position: relative;
	width: 768px;
	height: 720px;
	margin: 30px auto;
	}
#screen {
	position: relative;
	width: 256px;
	height: 240px;
	overflow: hidden;
	zoom:3;
	-moz-transform: scale(3); -moz-transform-origin: 0 0;
}
#screen div {
	position: absolute;
	left: 0;
	top: 0;
	width: 256px;
	height: 240px;
	overflow: hidden;
}
#game {
	image-rendering: -webkit-optimize-contrast;
}
#game #bg-layer {
	top: auto;
	bottom: 0;
	height: 1440px;
	background: #000 url(stars.png) no-repeat;
	z-index: 1;
}



#game #bg-layer.animate { 
	-moz-animation: moveBg 30s linear infinite;
	-webkit-animation: moveBg 30s linear infinite;
	-webkit-backface-visibility: hidden; /* to maybe prevent flickering */
}


#game-over {
	background: url(game-over.png) no-repeat;
	z-index: 20;
}

#title-screen {
	background: url(title-screen.png) no-repeat;
	z-index: 20;
}


/* UI
=============== */
ol.meter {
	position: absolute;
	margin: 0;
	padding: 0 0 15px;
	list-style: none;
	overflow: hidden;
	background: url(meter-cap.png) no-repeat 0 bottom;
	z-index: 10;
}

ol.meter li.meter-tick {
	position: absolute;
	list-style: none;
	margin: 0;
	padding: 0;
	background: #64b0ff url(meter-empty.png) no-repeat -16px 0;
	overflow: hidden;
}

ol.meter.hurt li.meter-tick {
	background: #b53120;
}

/* Game objects 
==================== */
#spaceman {
	position: absolute;
	overflow: hidden;
	background: url(spaceman.png) no-repeat;
	z-index: 2;
}
#spaceman.animate {	
-moz-animation: spriteSpaceman .3s step-start infinite; 
-webkit-animation: spriteSpaceman .3s step-start infinite; 
}

.powerup.o2 {
	position: absolute;
	overflow: hidden;
	background: url(o2bottle.png) no-repeat;
	z-index: 2;
}
.powerup.o2.animate {
-moz-animation: spriteO2bottle .2s step-start infinite; 
-webkit-animation: spriteO2bottle .2s step-start infinite; 
}

.meteoroid {
	position: absolute;
	overflow: hidden;
	z-index: 4;
}
.meteoroid.micro { background: url(m-micro.png) no-repeat; }
.meteoroid.micro.animate { 
-moz-animation: spriteMmicro .5s step-start infinite;
-webkit-animation: spriteMmicro .5s step-start infinite;
}

.meteoroid.norm { background: url(m-norm.png) no-repeat; }
.meteoroid.norm.animate { 
-moz-animation: spriteMnorm .6s step-start infinite; 
-webkit-animation: spriteMnorm .6s step-start infinite; 
}

.meteoroid.mega { background: url(m-mega.png) no-repeat; }
.meteoroid.mega.animate { 
-moz-animation: spriteMmega .7s step-start infinite; 
-webkit-animation: spriteMmega .7s step-start infinite; 
}


.solarwind {
	position: absolute;
	overflow: hidden;
	background: url(solarwind.png) no-repeat;
	z-index: 3;
}
.solarwind.animate { 
-moz-animation: spriteSolarwind .5s step-start infinite; 
-webkit-animation: spriteSolarwind .5s step-start infinite; 
}
</style>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6235553-5']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>
<body>
<div id="wrap">
<div id="screen">
	<div id="game">
		<div id="bg-layer"></div>
	</div>
</div>
</div>
<script type="text/javascript">
//     Zepto.js
//     (c) 2010, 2011 Thomas Fuchs
//     Zepto.js may be freely distributed under the MIT license.
;(function(a){String.prototype.trim===a&&(String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}),Array.prototype.reduce===a&&(Array.prototype.reduce=function(b){if(this===void 0||this===null)throw new TypeError;var c=Object(this),d=c.length>>>0,e=0,f;if(typeof b!="function")throw new TypeError;if(d==0&&arguments.length==1)throw new TypeError;if(arguments.length>=2)f=arguments[1];else do{if(e in c){f=c[e++];break}if(++e>=d)throw new TypeError}while(!0);while(e<d)e in c&&(f=b.call(a,f,c[e],e,c)),e++;return f})})();var Zepto=function(){function v(a){return{}.toString.call(a)=="[object Function]"}function w(a){return a instanceof Object}function x(a){return a instanceof Array}function y(a){return typeof a.length=="number"}function z(b){return b.filter(function(b){return b!==a&&b!==null})}function A(a){return a.length>0?[].concat.apply([],a):a}function B(a){return a.replace(/-+(.)?/g,function(a,b){return b?b.toUpperCase():""})}function C(a){return a.replace(/::/g,"/").replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").replace(/_/g,"-").toLowerCase()}function D(a){return a.filter(function(a,b,c){return c.indexOf(a)==b})}function E(a){return a in i?i[a]:i[a]=new RegExp("(^|\\s)"+a+"(\\s|$)")}function F(a,b){return typeof b=="number"&&!k[C(a)]?b+"px":b}function G(a){var b,c;return h[a]||(b=g.createElement(a),g.body.appendChild(b),c=j(b,"").getPropertyValue("display"),b.parentNode.removeChild(b),c=="none"&&(c="block"),h[a]=c),h[a]}function H(b,c){c===a&&l.test(b)&&RegExp.$1,c in q||(c="*");var d=q[c];return d.innerHTML=""+b,f.call(d.childNodes)}function I(a,b){return a=a||e,a.__proto__=I.prototype,a.selector=b||"",a}function J(b,d){if(!b)return I();if(d!==a)return J(d).find(b);if(v(b))return J(g).ready(b);if(b instanceof I)return b;var e;return x(b)?e=z(b):m.indexOf(b.nodeType)>=0||b===window?(e=[b],b=null):l.test(b)?(e=H(b.trim(),RegExp.$1),b=null):b.nodeType&&b.nodeType==3?e=[b]:e=c(g,b),I(e,b)}function K(b,c){return c===a?J(b):J(b).filter(c)}function L(a,b,c,d){return v(b)?b.call(a,c,d):b}function M(a,b,c){var d=a%2?b:b.parentNode;d&&d.insertBefore(c,a?a==1?d.firstChild:a==2?b:null:b.nextSibling)}function N(a,b){b(a);for(var c in a.childNodes)N(a.childNodes[c],b)}var a,b,c,d,e=[],f=e.slice,g=window.document,h={},i={},j=g.defaultView.getComputedStyle,k={"column-count":1,columns:1,"font-weight":1,"line-height":1,opacity:1,"z-index":1,zoom:1},l=/^\s*<(\w+)[^>]*>/,m=[1,9,11],n=["after","prepend","before","append"],o=g.createElement("table"),p=g.createElement("tr"),q={tr:g.createElement("tbody"),tbody:o,thead:o,tfoot:o,td:p,th:p,"*":g.createElement("div")},r=/complete|loaded|interactive/,s=/^\.([\w-]+)$/,t=/^#([\w-]+)$/,u=/^[\w-]+$/;return J.extend=function(a){return f.call(arguments,1).forEach(function(c){for(b in c)a[b]=c[b]}),a},J.qsa=c=function(a,b){var c;return a===g&&t.test(b)?(c=a.getElementById(RegExp.$1))?[c]:e:f.call(s.test(b)?a.getElementsByClassName(RegExp.$1):u.test(b)?a.getElementsByTagName(b):a.querySelectorAll(b))},J.isFunction=v,J.isObject=w,J.isArray=x,J.map=function(a,b){var c,d=[],e,f;if(y(a))for(e=0;e<a.length;e++)c=b(a[e],e),c!=null&&d.push(c);else for(f in a)c=b(a[f],f),c!=null&&d.push(c);return A(d)},J.each=function(a,b){var c,d;if(y(a)){for(c=0;c<a.length;c++)if(b(c,a[c])===!1)return a}else for(d in a)if(b(d,a[d])===!1)return a;return a},J.fn={forEach:e.forEach,reduce:e.reduce,push:e.push,indexOf:e.indexOf,concat:e.concat,map:function(a){return J.map(this,function(b,c){return a.call(b,c,b)})},slice:function(){return J(f.apply(this,arguments))},ready:function(a){return r.test(g.readyState)?a(J):g.addEventListener("DOMContentLoaded",function(){a(J)},!1),this},get:function(b){return b===a?this:this[b]},size:function(){return this.length},remove:function(){return this.each(function(){this.parentNode!=null&&this.parentNode.removeChild(this)})},each:function(a){return this.forEach(function(b,c){a.call(b,c,b)}),this},filter:function(a){return J([].filter.call(this,function(b){return b.parentNode&&c(b.parentNode,a).indexOf(b)>=0}))},end:function(){return this.prevObject||J()},andSelf:function(){return this.add(this.prevObject||J())},add:function(a,b){return J(D(this.concat(J(a,b))))},is:function(a){return this.length>0&&J(this[0]).filter(a).length>0},not:function(b){var c=[];if(v(b)&&b.call!==a)this.each(function(a){b.call(this,a)||c.push(this)});else{var d=typeof b=="string"?this.filter(b):y(b)&&v(b.item)?f.call(b):J(b);this.forEach(function(a){d.indexOf(a)<0&&c.push(a)})}return J(c)},eq:function(a){return a===-1?this.slice(a):this.slice(a,+a+1)},first:function(){var a=this[0];return a&&!w(a)?a:J(a)},last:function(){var a=this[this.length-1];return a&&!w(a)?a:J(a)},find:function(a){var b;return this.length==1?b=c(this[0],a):b=this.map(function(){return c(this,a)}),J(b)},closest:function(a,b){var d=this[0],e=c(b||g,a);e.length||(d=null);while(d&&e.indexOf(d)<0)d=d!==b&&d!==g&&d.parentNode;return J(d)},parents:function(a){var b=[],c=this;while(c.length>0)c=J.map(c,function(a){if((a=a.parentNode)&&a!==g&&b.indexOf(a)<0)return b.push(a),a});return K(b,a)},parent:function(a){return K(D(this.pluck("parentNode")),a)},children:function(a){return K(this.map(function(){return f.call(this.children)}),a)},siblings:function(a){return K(this.map(function(a,b){return f.call(b.parentNode.children).filter(function(a){return a!==b})}),a)},empty:function(){return this.each(function(){this.innerHTML=""})},pluck:function(a){return this.map(function(){return this[a]})},show:function(){return this.each(function(){this.style.display=="none"&&(this.style.display=null),j(this,"").getPropertyValue("display")=="none"&&(this.style.display=G(this.nodeName))})},replaceWith:function(a){return this.each(function(){J(this).before(a).remove()})},wrap:function(a){return this.each(function(){J(this).wrapAll(J(a)[0].cloneNode(!1))})},wrapAll:function(a){return this[0]&&(J(this[0]).before(a=J(a)),a.append(this)),this},unwrap:function(){return this.parent().each(function(){J(this).replaceWith(J(this).children())}),this},hide:function(){return this.css("display","none")},toggle:function(b){return(b===a?this.css("display")=="none":b)?this.show():this.hide()},prev:function(){return J(this.pluck("previousElementSibling"))},next:function(){return J(this.pluck("nextElementSibling"))},html:function(b){return b===a?this.length>0?this[0].innerHTML:null:this.each(function(a){var c=this.innerHTML;J(this).empty().append(L(this,b,a,c))})},text:function(b){return b===a?this.length>0?this[0].textContent:null:this.each(function(){this.textContent=b})},attr:function(c,d){var e;return typeof c=="string"&&d===a?this.length==0?a:c=="value"&&this[0].nodeName=="INPUT"?this.val():!(e=this[0].getAttribute(c))&&c in this[0]?this[0][c]:e:this.each(function(a){if(w(c))for(b in c)this.setAttribute(b,c[b]);else this.setAttribute(c,L(this,d,a,this.getAttribute(c)))})},removeAttr:function(a){return this.each(function(){this.removeAttribute(a)})},data:function(a,b){return this.attr("data-"+a,b)},val:function(b){return b===a?this.length>0?this[0].value:null:this.each(function(a){this.value=L(this,b,a,this.value)})},offset:function(){if(this.length==0)return null;var a=this[0].getBoundingClientRect();return{left:a.left+window.pageXOffset,top:a.top+window.pageYOffset,width:a.width,height:a.height}},css:function(c,d){if(d===a&&typeof c=="string")return this.length==0?a:this[0].style[B(c)]||j(this[0],"").getPropertyValue(c);var e="";for(b in c)e+=C(b)+":"+F(b,c[b])+";";return typeof c=="string"&&(e=C(c)+":"+F(c,d)),this.each(function(){this.style.cssText+=";"+e})},index:function(a){return a?this.indexOf(J(a)[0]):this.parent().children().indexOf(this[0])},hasClass:function(a){return this.length<1?!1:E(a).test(this[0].className)},addClass:function(a){return this.each(function(b){d=[];var c=this.className,e=L(this,a,b,c);e.split(/\s+/g).forEach(function(a){J(this).hasClass(a)||d.push(a)},this),d.length&&(this.className+=(c?" ":"")+d.join(" "))})},removeClass:function(b){return this.each(function(c){if(b===a)return this.className="";d=this.className,L(this,b,c,d).split(/\s+/g).forEach(function(a){d=d.replace(E(a)," ")}),this.className=d.trim()})},toggleClass:function(b,c){return this.each(function(d){var e=L(this,b,d,this.className);(c===a?!J(this).hasClass(e):c)?J(this).addClass(e):J(this).removeClass(e)})}},"filter,add,not,eq,first,last,find,closest,parents,parent,children,siblings".split(",").forEach(function(a){var b=J.fn[a];J.fn[a]=function(){var a=b.apply(this,arguments);return a.prevObject=this,a}}),["width","height"].forEach(function(b){J.fn[b]=function(c){var d,e=b.replace(/./,function(a){return a[0].toUpperCase()});return c===a?this[0]==window?window["inner"+e]:this[0]==g?g.documentElement["offset"+e]:(d=this.offset())&&d[b]:this.each(function(a){var d=J(this);d.css(b,L(this,c,a,d[b]()))})}}),n.forEach(function(a,b){J.fn[a]=function(a){var c=w(a)?a:H(a);if(!("length"in c)||c.nodeType)c=[c];if(c.length<1)return this;var d=this.length,e=d>1,f=b<2;return this.each(function(a,g){for(var h=0;h<c.length;h++){var i=c[f?c.length-h-1:h];N(i,function(a){a.nodeName!=null&&a.nodeName.toUpperCase()==="SCRIPT"&&(!a.type||a.type==="text/javascript")&&window.eval.call(window,a.innerHTML)}),e&&a<d-1&&(i=i.cloneNode(!0)),M(b,g,i)}})};var c=b%2?a+"To":"insert"+(b?"Before":"After");J.fn[c]=function(b){return J(b)[a](this),this}}),I.prototype=J.fn,J}();window.Zepto=Zepto,"$"in window||(window.$=Zepto),function(a){function f(a){return a._zid||(a._zid=d++)}function g(a,b,d,e){b=h(b);if(b.ns)var g=i(b.ns);return(c[f(a)]||[]).filter(function(a){return a&&(!b.e||a.e==b.e)&&(!b.ns||g.test(a.ns))&&(!d||a.fn==d)&&(!e||a.sel==e)})}function h(a){var b=(""+a).split(".");return{e:b[0],ns:b.slice(1).sort().join(" ")}}function i(a){return new RegExp("(?:^| )"+a.replace(" "," .* ?")+"(?: |$)")}function j(b,c,d){a.isObject(b)?a.each(b,d):b.split(/\s/).forEach(function(a){d(a,c)})}function k(b,d,e,g,i){var k=f(b),l=c[k]||(c[k]=[]);j(d,e,function(c,d){var e=i&&i(d,c),f=e||d,j=function(a){var c=f.apply(b,[a].concat(a.data));return c===!1&&a.preventDefault(),c},k=a.extend(h(c),{fn:d,proxy:j,sel:g,del:e,i:l.length});l.push(k),b.addEventListener(k.e,j,!1)})}function l(a,b,d,e){var h=f(a);j(b||"",d,function(b,d){g(a,b,d,e).forEach(function(b){delete c[h][b.i],a.removeEventListener(b.e,b.proxy,!1)})})}function p(b){var c=a.extend({originalEvent:b},b);return a.each(o,function(a,d){c[a]=function(){return this[d]=m,b[a].apply(b,arguments)},c[d]=n}),c}function q(a){if(!("defaultPrevented"in a)){a.defaultPrevented=!1;var b=a.preventDefault;a.preventDefault=function(){this.defaultPrevented=!0,b.call(this)}}}var b=a.qsa,c={},d=1,e={};e.click=e.mousedown=e.mouseup=e.mousemove="MouseEvents",a.event={add:k,remove:l},a.fn.bind=function(a,b){return this.each(function(){k(this,a,b)})},a.fn.unbind=function(a,b){return this.each(function(){l(this,a,b)})},a.fn.one=function(a,b){return this.each(function(c,d){k(this,a,b,null,function(a,b){return function(){var c=a.apply(d,arguments);return l(d,b,a),c}})})};var m=function(){return!0},n=function(){return!1},o={preventDefault:"isDefaultPrevented",stopImmediatePropagation:"isImmediatePropagationStopped",stopPropagation:"isPropagationStopped"};a.fn.delegate=function(b,c,d){return this.each(function(e,f){k(f,c,d,b,function(c){return function(d){var e,g=a(d.target).closest(b,f).get(0);if(g)return e=a.extend(p(d),{currentTarget:g,liveFired:f}),c.apply(g,[e].concat([].slice.call(arguments,1)))}})})},a.fn.undelegate=function(a,b,c){return this.each(function(){l(this,b,c,a)})},a.fn.live=function(b,c){return a(document.body).delegate(this.selector,b,c),this},a.fn.die=function(b,c){return a(document.body).undelegate(this.selector,b,c),this},a.fn.on=function(b,c,d){return c===undefined||a.isFunction(c)?this.bind(b,c):this.delegate(c,b,d)},a.fn.off=function(b,c,d){return c===undefined||a.isFunction(c)?this.unbind(b,c):this.undelegate(c,b,d)},a.fn.trigger=function(b,c){return typeof b=="string"&&(b=a.Event(b)),q(b),b.data=c,this.each(function(){this.dispatchEvent(b)})},a.fn.triggerHandler=function(b,c){var d,e;return this.each(function(f,h){d=p(typeof b=="string"?a.Event(b):b),d.data=c,d.target=h,a.each(g(h,b.type||b),function(a,b){e=b.proxy(d);if(d.isImmediatePropagationStopped())return!1})}),e},"focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout change select keydown keypress keyup error".split(" ").forEach(function(b){a.fn[b]=function(a){return this.bind(b,a)}}),["focus","blur"].forEach(function(b){a.fn[b]=function(a){if(a)this.bind(b,a);else if(this.length)try{this.get(0)[b]()}catch(c){}return this}}),a.Event=function(a,b){var c=document.createEvent(e[a]||"Events"),d=!0;if(b)for(var f in b)f=="bubbles"?d=!!b[f]:c[f]=b[f];return c.initEvent(a,d,!0,null,null,null,null,null,null,null,null,null,null,null,null),c}}(Zepto),function(a){function b(a){var b=this.os={},c=this.browser={},d=a.match(/WebKit\/([\d.]+)/),e=a.match(/(Android)\s+([\d.]+)/),f=a.match(/(iPad).*OS\s([\d_]+)/),g=!f&&a.match(/(iPhone\sOS)\s([\d_]+)/),h=a.match(/(webOS|hpwOS)[\s\/]([\d.]+)/),i=h&&a.match(/TouchPad/),j=a.match(/(BlackBerry).*Version\/([\d.]+)/);d&&(c.version=d[1]),c.webkit=!!d,e&&(b.android=!0,b.version=e[2]),g&&(b.ios=!0,b.version=g[2].replace(/_/g,"."),b.iphone=!0),f&&(b.ios=!0,b.version=f[2].replace(/_/g,"."),b.ipad=!0),h&&(b.webos=!0,b.version=h[2]),i&&(b.touchpad=!0),j&&(b.blackberry=!0,b.version=j[2])}b.call(a,navigator.userAgent),a.__detect=b}(Zepto),function(a,b){function k(a){return a.toLowerCase()}function l(a){return d?d+a:k(a)}var c="",d,e,f,g={Webkit:"webkit",Moz:"",O:"o",ms:"MS"},h=window.document,i=h.createElement("div"),j=/^((translate|rotate|scale)(X|Y|Z|3d)?|matrix(3d)?|perspective|skew(X|Y)?)$/i;a.each(g,function(a,e){if(i.style[a+"TransitionProperty"]!==b)return c="-"+k(a)+"-",d=e,!1}),a.fx={off:d===b&&i.style.transitionProperty===b,cssPrefix:c,transitionEnd:l("TransitionEnd"),animationEnd:l("AnimationEnd")},a.fn.animate=function(b,c,d,e){return a.isObject(c)&&(d=c.easing,e=c.complete,c=c.duration),c&&(c/=1e3),this.anim(b,c,d,e)},a.fn.anim=function(d,e,f,g){var h,i={},k,l=this,m,n=a.fx.transitionEnd;e===b&&(e=.4),a.fx.off&&(e=0);if(typeof d=="string")i[c+"animation-name"]=d,i[c+"animation-duration"]=e+"s",n=a.fx.animationEnd;else{for(k in d)j.test(k)?(h||(h=[]),h.push(k+"("+d[k]+")")):i[k]=d[k];h&&(i[c+"transform"]=h.join(" ")),a.fx.off||(i[c+"transition"]="all "+e+"s "+(f||""))}return m=function(){var b={};b[c+"transition"]=b[c+"animation-name"]="none",a(this).css(b),g&&g.call(this)},e>0&&this.one(n,m),setTimeout(function(){l.css(i),e<=0&&setTimeout(function(){l.each(function(){m.call(this)})},0)},0),this},i=null}(Zepto),function(a){function g(b,c,d){var e=a.Event(c);return a(b).trigger(e,d),!e.defaultPrevented}function h(a,b,c,e){if(a.global)return g(b||d,c,e)}function i(b){b.global&&a.active++===0&&h(b,null,"ajaxStart")}function j(b){b.global&&!--a.active&&h(b,null,"ajaxStop")}function k(a,b){var c=b.context;if(b.beforeSend.call(c,a,b)===!1||h(b,c,"ajaxBeforeSend",[a,b])===!1)return!1;h(b,c,"ajaxSend",[a,b])}function l(a,b,c){var d=c.context,e="success";c.success.call(d,a,e,b),h(c,d,"ajaxSuccess",[b,c,a]),n(e,b,c)}function m(a,b,c,d){var e=d.context;d.error.call(e,c,b,a),h(d,e,"ajaxError",[c,d,a]),n(b,c,d)}function n(a,b,c){var d=c.context;c.complete.call(d,b,a),h(c,d,"ajaxComplete",[b,c]),j(c)}function o(){}function q(b,d,e,f){var g=a.isArray(d);a.each(d,function(d,h){f&&(d=e?f:f+"["+(g?"":d)+"]"),!f&&g?b.add(h.name,h.value):(e?a.isArray(h):c(h))?q(b,h,e,d):b.add(d,h)})}var b=0,c=a.isObject,d=window.document,e,f;a.active=0,a.ajaxJSONP=function(c){var e="jsonp"+ ++b,f=d.createElement("script"),g=function(){a(f).remove(),e in window&&(window[e]=o),n(h,c,"abort")},h={abort:g},i;return window[e]=function(b){clearTimeout(i),a(f).remove(),delete window[e],l(b,h,c)},f.src=c.url.replace(/=\?/,"="+e),a("head").append(f),c.timeout>0&&(i=setTimeout(function(){h.abort(),n(h,c,"timeout")},c.timeout)),h},a.ajaxSettings={type:"GET",beforeSend:o,success:o,error:o,complete:o,context:null,global:!0,xhr:function(){return new window.XMLHttpRequest},accepts:{script:"text/javascript, application/javascript",json:"application/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},crossDomain:!1,timeout:0},a.ajax=function(b){var d=a.extend({},b||{});for(e in a.ajaxSettings)d[e]===undefined&&(d[e]=a.ajaxSettings[e]);i(d),d.crossDomain||(d.crossDomain=/^([\w-]+:)?\/\/([^\/]+)/.test(d.url)&&RegExp.$2!=window.location.host);if(/=\?/.test(d.url))return a.ajaxJSONP(d);d.url||(d.url=window.location.toString()),d.data&&!d.contentType&&(d.contentType="application/x-www-form-urlencoded"),c(d.data)&&(d.data=a.param(d.data));if(d.type.match(/get/i)&&d.data){var g=d.data;d.url.match(/\?.*=/)?g="&"+g:g[0]!="?"&&(g="?"+g),d.url+=g}var h=d.accepts[d.dataType],j={},n=/^([\w-]+:)\/\//.test(d.url)?RegExp.$1:window.location.protocol,p=a.ajaxSettings.xhr(),q;d.crossDomain||(j["X-Requested-With"]="XMLHttpRequest"),h&&(j.Accept=h),d.headers=a.extend(j,d.headers||{}),p.onreadystatechange=function(){if(p.readyState==4){clearTimeout(q);var a,b=!1;if(p.status>=200&&p.status<300||p.status==0&&n=="file:"){if(h=="application/json"&&!/^\s*$/.test(p.responseText))try{a=JSON.parse(p.responseText)}catch(c){b=c}else a=p.responseText;b?m(b,"parsererror",p,d):l(a,p,d)}else m(null,"error",p,d)}},p.open(d.type,d.url,!0),d.contentType&&(d.headers["Content-Type"]=d.contentType);for(f in d.headers)p.setRequestHeader(f,d.headers[f]);return k(p,d)===!1?(p.abort(),!1):(d.timeout>0&&(q=setTimeout(function(){p.onreadystatechange=o,p.abort(),m(null,"timeout",p,d)},d.timeout)),p.send(d.data),p)},a.get=function(b,c){return a.ajax({url:b,success:c})},a.post=function(b,c,d,e){return a.isFunction(c)&&(e=e||d,d=c,c=null),a.ajax({type:"POST",url:b,data:c,success:d,dataType:e})},a.getJSON=function(b,c){return a.ajax({url:b,success:c,dataType:"json"})},a.fn.load=function(b,c){if(!this.length)return this;var e=this,f=b.split(/\s/),g;return f.length>1&&(b=f[0],g=f[1]),a.get(b,function(b){e.html(g?a(d.createElement("div")).html(b).find(g).html():b),c&&c.call(e)}),this};var p=encodeURIComponent;a.param=function(a,b){var c=[];return c.add=function(a,b){this.push(p(a)+"="+p(b))},q(c,a,b),c.join("&").replace("%20","+")}}(Zepto),function(a){a.fn.serializeArray=function(){var b=[],c;return a(Array.prototype.slice.call(this.get(0).elements)).each(function(){c=a(this);var d=c.attr("type");!this.disabled&&d!="submit"&&d!="reset"&&d!="button"&&(d!="radio"&&d!="checkbox"||this.checked)&&b.push({name:c.attr("name"),value:c.val()})}),b},a.fn.serialize=function(){var a=[];return this.serializeArray().forEach(function(b){a.push(encodeURIComponent(b.name)+"="+encodeURIComponent(b.value))}),a.join("&")},a.fn.submit=function(b){if(b)this.bind("submit",b);else if(this.length){var c=a.Event("submit");this.eq(0).trigger(c),c.defaultPrevented||this.get(0).submit()}return this}}(Zepto),function(a){function d(a){return"tagName"in a?a:a.parentNode}function e(a,b,c,d){var e=Math.abs(a-b),f=Math.abs(c-d);return e>=f?a-b>0?"Left":"Right":c-d>0?"Up":"Down"}function g(){b.last&&Date.now()-b.last>=f&&(a(b.target).trigger("longTap"),b={})}var b={},c,f=750;a(document).ready(function(){a(document.body).bind("touchstart",function(a){var e=Date.now(),h=e-(b.last||e);b.target=d(a.touches[0].target),c&&clearTimeout(c),b.x1=a.touches[0].pageX,b.y1=a.touches[0].pageY,h>0&&h<=250&&(b.isDoubleTap=!0),b.last=e,setTimeout(g,f)}).bind("touchmove",function(a){b.x2=a.touches[0].pageX,b.y2=a.touches[0].pageY}).bind("touchend",function(d){b.isDoubleTap?(a(b.target).trigger("doubleTap"),b={}):b.x2>0||b.y2>0?((Math.abs(b.x1-b.x2)>30||Math.abs(b.y1-b.y2)>30)&&a(b.target).trigger("swipe")&&a(b.target).trigger("swipe"+e(b.x1,b.x2,b.y1,b.y2)),b.x1=b.x2=b.y1=b.y2=b.last=0):"last"in b&&(c=setTimeout(function(){c=null,a(b.target).trigger("tap"),b={}},250))}).bind("touchcancel",function(){b={}})}),["swipe","swipeLeft","swipeRight","swipeUp","swipeDown","doubleTap","tap","longTap"].forEach(function(b){a.fn[b]=function(a){return this.bind(b,a)}})}(Zepto)


/* HELPERS */

/* Simple JavaScript Inheritance
 * By John Resig http://ejohn.org/
 * MIT Licensed.
 * http://ejohn.org/blog/simple-javascript-inheritance/
 */
// Inspired by base2 and Prototype
;(function(){
  var initializing = false, fnTest = /xyz/.test(function(){xyz;}) ? /\b_super\b/ : /.*/;
  // The base Class implementation (does nothing)
  this.Class = function(){};
  
  // Create a new Class that inherits from this class
  Class.extend = function(prop) {
    var _super = this.prototype;
    
    // Instantiate a base class (but only create the instance,
    // don't run the init constructor)
    initializing = true;
    var prototype = new this();
    initializing = false;
    
    // Copy the properties over onto the new prototype
    for (var name in prop) {
      // Check if we're overwriting an existing function
      prototype[name] = typeof prop[name] == "function" && 
        typeof _super[name] == "function" && fnTest.test(prop[name]) ?
        (function(name, fn){
          return function() {
            var tmp = this._super;
            
            // Add a new ._super() method that is the same method
            // but on the super-class
            this._super = _super[name];
            
            // The method only need to be bound temporarily, so we
            // remove it when we're done executing
            var ret = fn.apply(this, arguments);        
            this._super = tmp;
            
            return ret;
          };
        })(name, prop[name]) :
        prop[name];
    }
    
    // The dummy class constructor
    function Class() {
      // All construction is actually done in the init method
      if ( !initializing && this.init )
        this.init.apply(this, arguments);
    }
    
    // Populate our constructed prototype object
    Class.prototype = prototype;
    
    // Enforce the constructor to be what we expect
    Class.prototype.constructor = Class;

    // And make this class extendable
    Class.extend = arguments.callee;
    
    return Class;
  };
})();

// http://stackoverflow.com/questions/2752349/fast-rectangle-to-rectangle-intersection
function intersectRect(r1, r2) {
	return !(r2.origin.x > r1.origin.x+r1.size.width 	||	// r2 is right of r1
		r2.origin.x+r2.size.width < r1.origin.x 		||	// r2 is left of r1
		r2.origin.y > r1.origin.y+r1.size.height 		||	// r2 is below r1
		r2.origin.y+r2.size.height < r1.origin.y);			// r2 is above r1
}

// shaun inman - shauninman.com/ludumdare/escape/
var Size 	= function(w,h) { return {'width':w, 'height':h}; };
var Point 	= function(x,y) { return {'x':x, 'y':y}; };
var Rect	= function(x,y,w,h) { return {'origin':Point(x,y), 'size':Size(w,h)}; };


/* GAME CODE STARTS HERE ========================================================================================= */
/*  FAR FROM HOME
*	(c) 2011 Matt Grimm
*	Created Dec 17-18, 2011 - Ludem Dare 22: Theme ALONE
*/
$(function(){

var BG; // holds bg-layer div

var Meter = Class.extend({
	init: function(x,y,ticks){
		var new_tick, meter_height = 0,  t_y = -6, t_h = 5, t_padding = 1; // -6 id hacky, to get the first tick at position 0
		
		this.collidable = false;
		this.isVisible = true;
		this.children = [];
		this.flash = false;
		this.flash_timer = 0;
		this.FLASH_MAX = 12; // how long to show the flash in ms
		
		this.el = $('<ol class="meter"></ol>');
		
		while (ticks--) {
			t_y = t_y + t_h + t_padding;
			meter_height = meter_height + t_h + t_padding;
			new_tick = new MeterTick(0, t_y, 15, t_h, this);
			this.children.push(new_tick);
		}		
		
		this.body = new Rect(x,y,15,meter_height);
		this.pointer = {tick:this.children[0], index:0}; // the active meter tick
		this.el.css({
			left: this.body.origin.x,
			top: this.body.origin.y,
			width: this.body.size.width,
			height: this.body.size.height
		}).appendTo('#'+game.id);
	},
	update: function(){
		var ticks = this.children, tmp_indx;
		
		// update all children (meter ticks)
		for (var i=0,len=ticks.length; i<len; i++) {
				ticks[i].update();
		}
		
		if (this.flash) {
			if (this.flash_timer < this.FLASH_MAX) {
				this.flash_timer++;
			} else {
				this.el.removeClass('hurt');
				this.flash = false;
				this.flash_timer = 0; // reset timer for the future
			}
		}
		
		
		if (game.warn_o2) {
			this.pointer.tick.dying = true;
		}
		
		if (game.lost_o2) {
			// kill the dying tick
			this.pointer.tick.dying = false;
			this.pointer.tick.dead = true;
			
			// increase pointer to next tick
			tmp_indx = this.pointer.index + 1;
			if (tmp_indx > ticks.length-1) {
				// kill last tick
				this.pointer.tick.status = this.pointer.tick.off;
				
				// and game over
				game.isGameOver = true;				
			} else {
				this.pointer.index = tmp_indx;
				this.pointer.tick = ticks[tmp_indx];
			}
			game.lost_o2 = false; // reset flag
		}
	
		if (game.add_o2 > 0) {
				
			// stop any death on current tick
			this.pointer.tick.revive = true;
			this.pointer.tick.dying = false;
			this.pointer.tick.dead = false;
			
			// decrease pointer to prev tick
			tmp_indx = this.pointer.index - 1;
			
			if (tmp_indx >= 0) {
				this.pointer.index = tmp_indx;
				this.pointer.tick = ticks[tmp_indx];
				
			
				// revive the old tick
				this.pointer.tick.revive = true;
				this.pointer.tick.dying = false;
				this.pointer.tick.dead = false;
			}
			
			game.add_o2 = game.add_o2 -1; // subtract from the number of o2 powerups we have waiting
		}
			
	},
	render: function(){
		var ticks = this.children;
		// render all children (meter ticks)
		for (var i=0,len=ticks.length; i<len; i++) {
			if (ticks[i].isVisible) {
				ticks[i].render();
			}
		}
	},
	flashMeter: function() {
		this.el.addClass('hurt');
		this.flash = true;
	}
});


var MeterTick = Class.extend({
	init: function(x,y,w,h,parent){
		this.body = new Rect(x,y,w,h);
		this.isVisible = true;
		this.dying = false;
		this.dead = false;
		this.revive = false;
		
		this.on = -16;
		this.off = 0;
		
		this.status = this.on;
		
		this.MAX_WARN_TIME = 1000 / 50; // esentially fps for blinking meter ticks
		this.warn_timer = 0;
		
		this.parent = parent;
		this.el = $('<li class="meter-tick"></li>').css({
			left: this.body.origin.x,
			top: this.body.origin.y,
			width: this.body.size.width,
			height: this.body.size.height
		}).appendTo(this.parent.el);
		
	},
	update: function(){
		if (this.dying) {
			
			if (this.warn_timer < this.MAX_WARN_TIME) {
				this.warn_timer++;
			} else {
				if (this.status === this.on) {
					this.status = this.off;
				} else {
					this.status = this.on;
				}
				this.warn_timer = 0; // reset warn timer;
			}
			
		}
		
		if (this.dead) {
			this.status = this.off;
		}
		
		if (this.revive) {
			this.status = this.on;
			this.revive = false; //reset flag
		}
	},
	render: function(){
		this.el.css({
			'background-position': this.status + " 0"
		});
	}
});




var Player = Class.extend({
	init: function(){
		this.collidable = false;
		this.isVisible = true;
		this.x_acc = 0; // ACC = acceleration
		this.y_acc = 0;
		this.VELOCITY = .2;
		this.ACC_INC = .03;
		this.MAX_ACC = 2.5;
		this.x_dir;
		this.y_dir;
		this.last_hit;
		
		this.body = new Rect(117,160,22,32);
		this.id = 'spaceman';
		this.el = $('<i id="'+this.id+'" class="animate"></i>').css({
			left: this.body.origin.x,
			top: this.body.origin.y,
			width: this.body.size.width,
			height: this.body.size.height
		}).appendTo('#'+game.id);
	},
	update: function(){
		var current_x = this.body.origin.x;
		var current_y = this.body.origin.y;
		var current_x_acc = this.x_acc;
		var current_y_acc = this.y_acc;
		var collision = false;
		var collision_obj, collision_meta;
		var game_objects = game.children;
		
		//// X DIR
		if (game.input.isPressed(game.input.LEFT)) {
			if (current_x_acc <= this.MAX_ACC ) { current_x_acc += this.ACC_INC; }
			this.x_dir = 'left';
		} else if (game.input.isPressed(game.input.RIGHT)) {
			if (current_x_acc <= this.MAX_ACC ) { current_x_acc += this.ACC_INC; }
			this.x_dir = 'right';
		} else {
			if (current_x_acc > 0 ) { current_x_acc -= .01;
			} else if (current_x_acc < 0) { current_x_acc = 0; } // stop the crazy numbers		
		}
		
		if (this.x_dir === 'left') {
			current_x = current_x - (this.VELOCITY * current_x_acc);
		} else {
			current_x = current_x + (this.VELOCITY * current_x_acc);
		}
		// store new values
		this.x_acc = current_x_acc;
		if (current_x >= -8 && current_x <= 242) {
			this.body.origin.x = current_x;
		}
		
		
		//// Y DIR
		if (game.input.isPressed(game.input.UP)) {
			if (current_y_acc <= this.MAX_ACC ) { current_y_acc += this.ACC_INC; }
			this.y_dir = 'up';
		} else if (game.input.isPressed(game.input.DOWN)) {
			if (current_y_acc <= this.MAX_ACC ) { current_y_acc += this.ACC_INC; }
			this.y_dir = 'down';
		} else {
			if (current_y_acc > 0 ) { current_y_acc -= .01;	
			} else if (current_y_acc < 0) { current_y_acc = 0; }		
		}
		
		if (this.y_dir === 'up') {
			current_y = current_y - (this.VELOCITY * current_y_acc);
		} else {
			current_y = current_y + (this.VELOCITY * current_y_acc);
		}
		// store new values
		this.y_acc = current_y_acc;
		if (current_y <= 207 && current_y >= 1) {
			this.body.origin.y = current_y;
		}
		
		
		for (var i=0; i < game_objects.length; i++ ) { // dont cache length, changes too often 
			if (game_objects[i].collidable) {
				collision = intersectRect(game_objects[i].body,this.body);
				if (collision) {
					
					collision_obj = game_objects[i];
					collision_meta = collision_obj.meta;
					
					if (collision_meta.class === 'enemy') {
						switch(collision_meta.type) {
							case 'meteoroid':
									

								// only let meteoroids hurt once	
								if (this.last_hit !== collision_obj) {	
									
									// push player away
									this.x_acc = this.MAX_ACC + 1;
									this.y_acc = this.MAX_ACC + 1;
									if (this.x_dir === 'left') {
											this.x_dir = 'right';
										} else {
											this.x_dir = 'left';
										}
									
									// show it hurt, SUPER hacky - should not really depend on the position in that array
									game_objects[1].flashMeter();
									
									// Reduce timers
									var tmp_warn_time = game.WARN_INTR-collision_obj.damage;
									
									if (tmp_warn_time > 10 ) {
										game.WARN_INTR = tmp_warn_time;
									}
									
									var tmp_kill_time = game.KILL_INTR-collision_obj.damage;
									if (tmp_kill_time > 10) {
										game.KILL_INTR = tmp_kill_time;
									}
									
									this.last_hit = collision_obj;
								}
							break;
							
							case 'solarwind':
								// push player around
								this.x_acc = this.MAX_ACC + 1;
								this.y_acc = this.MAX_ACC + 1;
								
								// sometimes flip player x position, sometimes y
								if (Math.random() > .5) {
									if (this.x_dir === 'left') {
										this.x_dir = 'right';
									} else {
										this.x_dir = 'left';
									}
								} else {
									if (this.y_dir === 'up') {
										this.y_dir = 'down';
									} else {
										this.y_dir = 'up';
									}
								}
							break;
						}
					} else if (collision_meta.class === 'powerup') {
						switch(collision_meta.type) {
							case 'o2':
								collision_obj.kill(); // remove the power up from the game
								game.add_o2 = collision_obj.power; // add the power up power
							break;
						}
					}
				
				}
			}
		}
		
		
	}, 
	render: function(){
		this.el.css({
			left: this.body.origin.x,
			top: this.body.origin.y
		});
	}
});

var Item = Class.extend({
	init: function(){}
});
Item.randomStartPoint = function(){
	var x, y=-64, max=248, min= -8;
	x = Math.floor(Math.random() * (max - min + 1)) + min; // http://stackoverflow.com/questions/1527803/generating-random-numbers-in-javascript
	return new Point(x,y);
};



var PowerUp = Item.extend({
	init: function(x,y,type) {
	
		this.meta = {class:'powerup', type:type}
		this.collidable = true;
		this.isVisible	= true;
		this.type = type;
		
		this.speed = .5;
		this.power = 2;
		
		// safety check, dont want powerups hidden on the sides
		if (x < 25) {
			x += 30;
		} else if (x > 248) {
			x -= 27;
		}
		
		switch(type) {
			case 'o2':
				this.body = new Rect(x,y,10,25);
			break;
		}
		
		this.el = $('<i class="powerup '+this.type+' animate"></i>').css({
			left: this.body.origin.x,
			top: this.body.origin.y,
			width: this.body.size.width,
			height: this.body.size.height
		}).appendTo('#'+game.id);
	},
	update: function(){
		var current_y = this.body.origin.y;
		if (current_y >= 241) {
			game.removeChild(this);
		}
		
		current_y = current_y + this.speed;
		this.body.origin.y = current_y;
	},
	render: function(){
		this.el.css({
			left: this.body.origin.x,
			top: this.body.origin.y
		});
	},
	kill: function(){
		game.removeChild(this);
	}
});



var Enemy = Item.extend({
	init: function(x,y,type){
		this.meta = {class:'enemy', type:type};
		this.collidable = true;
		this.isVisible	= true;
		this.type = type;
		
		switch(type) {
			case 'solarwind':
				this.body = new Rect(x,y,29,32);
			break;
		}
		this.speed = .5;
		this.el = $('<i class="enemy '+this.type+' animate"></i>').css({
			left: this.body.origin.x,
			top: this.body.origin.y,
			width: this.body.size.width,
			height: this.body.size.height
		}).appendTo('#'+game.id);
	},
	update: function(){
		var current_y = this.body.origin.y;
		if (current_y >= 241) {
			game.removeChild(this);
		}
		
		current_y = current_y + this.speed;
		this.body.origin.y = current_y;
	},
	render: function(){
		this.el.css({
			left: this.body.origin.x,
			top: this.body.origin.y
		});
	}
});



var Meteoroid = Enemy.extend({
	init: function(x,y,type){
		var w,h;

		this.meta = {class:'enemy', type:'meteoroid'}
		this.collidable = true;
		this.isVisible	= true;
		this.type = type;
		
		switch(type) {
			case 'micro':
				w=16;
				h=16;
				this.damage = 1;
			break;
			case 'norm':
				w=31;
				h=31;
				this.damage = 2;
			break;
			case 'mega':
				w=63;
				h=63;
				this.damage = 3;
			break;
			default:
				this.type = 'norm';
				w=31;
				h=31;
				this.damage = 60;
		}
		this.speed = .8;
		this.body = new Rect(x,y,w,h);
		this.el = $('<i class="meteoroid '+this.type+' animate"></i>').css({
			left: this.body.origin.x,
			top: this.body.origin.y,
			width: this.body.size.width,
			height: this.body.size.height
		}).appendTo('#'+game.id);
	},
	update: function() {
		var current_y = this.body.origin.y;
		if (current_y >= 241) {
			game.removeChild(this);
		}
		
		current_y = current_y + this.speed;	
		this.body.origin.y = current_y;
	},
	render: function() {
		this.el.css({
			left: this.body.origin.x,
			top: this.body.origin.y
		});
	}
});


// use like static methods
Meteoroid.randomMeteoroid = function(x,y){
		var type = Meteoroid.types[Math.floor(Math.random()*Meteoroid.types.length)];
		return new Meteoroid(x,y,type);
	};
Meteoroid.Norm = 'norm';
Meteoroid.Micro = 'micro';
Meteoroid.Mega = 'mega';

Meteoroid.types = [Meteoroid.Norm,
			Meteoroid.Norm,
			Meteoroid.Norm,
			Meteoroid.Norm,
			Meteoroid.Micro,
			Meteoroid.Micro,
			Meteoroid.Micro,
			Meteoroid.Micro,
			Meteoroid.Micro,
			Meteoroid.Mega,
			Meteoroid.Mega];



var InputManager = Class.extend({
	init: function(target_ele){
		var that = this;
		this.LEFT = 37;
		this.UP = 38;
		this.RIGHT = 39;
		this.DOWN = 40;
		this.pressed = [];
		
		target_ele.bind('keydown', function(e){that.handleKeyDown(e)});
		target_ele.bind('keyup', function(e){that.handleKeyUp(e)});
	},
	handleKeyDown: function(e){
		this.pressed[e.which] = true;
		this.stopScroll(e);
	},
	handleKeyUp: function(e){
		this.pressed[e.which] = false;
		this.stopScroll(e);
	},
	stopScroll: function(e){
		if (e.which >= 37 && e.which <= 40) {e.preventDefault();}
	},
	isPressed: function(key){
		var key_val = this.pressed[key];
		if (key_val !== undefined) { return key_val; }
		return false;
	}
});




var Game = Class.extend({
		init: function(){
			this.isNotRunning = true;
			this.MAX_OBJECTS = 27; // used to make sure we don't add too many enemies at once
			this.input = new InputManager($(document));
			this.id = 'game';
			
			this.reset();
			this.showTitle();
			this.WARN_INTR = 120; // 120 ~ 2s (in "game time" has passed)  60fps(ideal) * 2s
			this.KILL_INTR = 180; // 180 ~ 3s 
			this.O2_INTR = 450;   // 450 ~ 7.5s
		},
		reset: function() {
			// clear everything in the game, then add the bg
			$('#'+this.id).html('').append('<div id="bg-layer" class="animate"></div>');
			BG = $('#bg-layer');
			this.children = [];
		},
		start: function (){
			var spaceman = new Player;
			var o2meter = new Meter(10,10,20);
			this.lost_o2 = false;
			this.warn_o2 = false;
			this.add_o2 = 0;
			this.isGameOver = false;
			this.isNotRunning = false;
			
			this.freeze = false;
			this.frames = 0;
			this.maxloops = 5;
			this.loops = 0;
			this.skip_ticks = 1000 / 60; 
			this.next_tick = Date.now();
			this.addChild(spaceman);
			this.addChild(o2meter);
			this.interval_id = setInterval(this.loop, 1000/60);
		},
		loop: function(){
			game.loops = 0;
			
			while( Date.now() > game.next_tick && game.loops < game.maxloops) {
				game.update();
				game.next_tick += game.skip_ticks;
				game.loops++;
				game.frames++;
			}
			
			game.render(); 
		},
		update: function(){
			var new_enemy, new_item_start_point, new_powerup;
			
			// if paused
			if (game.freeze) { return; }
			
			if (game.isGameOver) {
			
				// clear all children
				if (game.children.length) {
					game.removeAllChildren();
				} else {
					game.isNotRunning = true;
					game.showGameOver();
				}
			
			} else {
				var game_objects = this.children; // local variable for speed
				// update all children (game objects)
				for (var i=0; i<game_objects.length; i++) {  // dont cache the array length, this changes too often, we need to know the current length on each iteration
					game_objects[i].update();
				}
				
				
				// every 1.5s (in game time)
				if (game.frames % 90 === 0) {
					if (game_objects.length < this.MAX_OBJECTS) { // dont let too many objects show up
						// add a new meteoroid
						new_item_start_point = Item.randomStartPoint();
						new_enemy = Meteoroid.randomMeteoroid(new_item_start_point.x, new_item_start_point.y);
						game.addChild(new_enemy);
					}
				}
				
				
				// after first frame passes
				if (game.frames !== 0) {
				
					// At random times, new solarwind		
					if (game.frames % Math.round(Math.random() * 5500) === 0) {
						if (game_objects.length < this.MAX_OBJECTS) {
							// add a new solar wind enemy
							new_item_start_point = Item.randomStartPoint();
							new_enemy = new Enemy(new_item_start_point.x, new_item_start_point.y, 'solarwind');
							game.addChild(new_enemy);
						}
					}
				
				
					/* check timers
					================================= */
					// warn
					if (game.frames % game.WARN_INTR === 0 ) {
						game.warn_o2 = true;
					}
					
					// kill o2
					if (game.frames % game.KILL_INTR === 0 ) {
						game.warn_o2 = false;
						game.lost_o2 = true;
					}
					
					// new o2 bottle powerup
					if (game.frames % game.O2_INTR === 0) {
						new_item_start_point = Item.randomStartPoint();
						new_powerup = new PowerUp(new_item_start_point.x,new_item_start_point.y,'o2');
						game.addChild(new_powerup);					
					}
				}
			
			}			
		},
		render: function(){
			var game_objects = game.children; // local variable for speed
			
			// render all children (game objects)
			for (var i=0,len=game_objects.length; i<len; i++) {
				if (game_objects[i].isVisible) {
					game_objects[i].render();
				}
			} 
		},
		addChild: function(child){
			game.children.push(child);
		},
		removeChild: function(child){
			var game_objects = game.children; // local variable for speed
			for (var i=0; i<game_objects.length; i++) { // dont cache length, changes too much
				if (game_objects[i] === child) {
					game_objects[i].el.remove(); // remove from dom
					game_objects.splice(i,1); // remove from child list
					break;
				}
			}
		},
		removeAllChildren: function() {
			var game_objects = game.children; // local variable for speed
			for (var i=0; i<game_objects.length; i++) {
					game_objects[i].el.remove(); // remove from dom
					game_objects.splice(i,1); // remove from child list
				}
		},
		showTitle: function() {
			$('#'+this.id).append('<div id="title-screen"></div>');
		},
		showGameOver: function() {
			if ($('#game-over', '#'+game.id).length === 0) {
				$('#'+game.id).append('<div id="game-over"></div>');
			}
		}
	});

var game = new Game;

$(document).bind('keypress',function(e){
	if (game.isNotRunning)	{
		if (e.which === 13) {
			clearInterval(game.interval_id); // stop old timers
			game.reset();
			game.start();
		}
	}
});

});
</script>
</body>
</html>